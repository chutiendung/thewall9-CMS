"use strict";var app=angular.module("app",["LocalStorageModule","blockUI"]);app.config(["blockUIConfig",function(a){a.message="Cargando...",a.delay=100}]),app.constant("ngAuthSettings",{apiServiceBaseUri:serviceBase,clientId:"ngAuthApp"}),app.run(["authService",function(a){a.fillAuthData()}]),app.factory("authInterceptorService",["$q","$injector","$location","localStorageService","blockUI",function(a,b,c,d,e){var f={};return f.request=function(a){null==e.noOpen&&e.start(),a.headers=a.headers||{};var b=d.get("authorizationData");return b&&(a.headers.Authorization="Bearer "+b.token),a},f.responseError=function(b){return null==e.noOpen?e.stop():e.noOpen=null,a.reject(b)},f.response=function(b){return null==e.noOpen?e.stop():e.noOpen=null,b||a.when(b)},f}]),app.factory("authService",["$http","$q","localStorageService","ngAuthSettings","utilService",function(a,b,c,d,e){var f=d.apiServiceBaseUri,g={},h={isAuth:!1,userName:"",useRefreshTokens:!1},i={provider:"",userName:"",externalAccessToken:""},j=function(b){return l(),a.post(f+"api/account/register",b).then(function(a){return a})},k=function(e){var g="grant_type=password&username="+e.userName+"&password="+e.password;g=g+"&client_id="+d.clientId;var i=b.defer();return a.post(f+"token",g,{headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(a){c.set("authorizationData",{token:a.access_token,userName:e.userName,refreshToken:a.refresh_token,useRefreshTokens:!0}),h.isAuth=!0,h.userName=e.userName,h.useRefreshTokens=e.useRefreshTokens,i.resolve(a)}).error(function(a,b){l(!0),i.reject(a)}),i.promise},l=function(a){c.remove("authorizationData"),h.isAuth=!1,h.userName="",h.useRefreshTokens=!1,null==a&&(window.location="/")},m=function(){var a=c.get("authorizationData");a&&(h.isAuth=!0,h.userName=a.userName,h.useRefreshTokens=a.useRefreshTokens)},n=function(){var e=b.defer(),g=c.get("authorizationData");if(g&&g.useRefreshTokens){var h="grant_type=refresh_token&refresh_token="+g.refreshToken+"&client_id="+d.clientId;c.remove("authorizationData"),a.post(f+"token",h,{headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(a){c.set("authorizationData",{token:a.access_token,userName:a.userName,refreshToken:a.refresh_token,useRefreshTokens:!0}),e.resolve(a)}).error(function(a,b){l(),e.reject(a)})}return e.promise},o=function(d){var e=b.defer();return a.get(f+"api/account/ObtainLocalAccessToken",{params:{provider:d.provider,externalAccessToken:d.externalAccessToken}}).success(function(a){c.set("authorizationData",{token:a.access_token,userName:a.userName,refreshToken:"",useRefreshTokens:!1}),h.isAuth=!0,h.userName=a.userName,h.useRefreshTokens=!1,e.resolve(a)}).error(function(a,b){l(),e.reject(a)}),e.promise},p=function(d){var e=b.defer();return a.post(f+"api/account/registerexternal",d).success(function(a){c.set("authorizationData",{token:a.access_token,userName:a.userName,refreshToken:"",useRefreshTokens:!1}),h.isAuth=!0,h.userName=a.userName,h.useRefreshTokens=!1,e.resolve(a)}).error(function(a,b){l(),e.reject(a)}),e.promise};return g.saveRegistration=j,g.login=k,g.logOut=l,g.fillAuthData=m,g.authentication=h,g.refreshToken=n,g.obtainAccessToken=o,g.externalAuthData=i,g.registerExternal=p,g.changePassword=function(b){return a.post(f+"api/account/changepassword",b)},g.roles=[],g.isAdmin=!1,g.getRoles=function(){var c=b.defer();return a.get(f+"api/account/roles").success(function(a){g.roles=a,angular.forEach(a,function(a){"admin"==a&&(g.isAdmin=!0)}),c.resolve(a)}).error(e.errorCallback),c.promise},g}]),app.factory("blogService",["$myhttp","$q","ngAuthSettings","siteService","cultureService",function(a,b,c,d,e){var f="api/blog",g={};return g.get=function(){return a.get(c.apiServiceBaseUri+f+"?SiteID="+d.site.SiteID+"&CultureID="+e.currentCulture.CultureID)},g.getByID=function(b){return a.get(c.apiServiceBaseUri+f+"/byID?BlogPostID="+b+"&CultureID="+e.currentCulture.CultureID)},g.save=function(b){return b.SiteID=d.site.SiteID,b.CultureID=e.currentCulture.CultureID,a.post(c.apiServiceBaseUri+f,b)},g.remove=function(b){return a["delete"](c.apiServiceBaseUri+f+"?BlogPostID="+b)},g.getCategories=function(){return a.get(c.apiServiceBaseUri+f+"/category?SiteID="+d.site.SiteID+"&CultureID="+e.currentCulture.CultureID)},g.editCategory=function(a,b){null==a?b.itemToSave={CategoryCultures:[]}:b.itemToSave=a,angular.forEach(e.cultures,function(a){var c=!1;angular.forEach(b.itemToSave.CategoryCultures,function(b){a.CultureID==b.CultureID&&(c=!0)}),c||b.itemToSave.CategoryCultures.push({CultureID:a.CultureID,CultureName:a.Name})}),$("#modal-new").modal({backdrop:!0})},g.saveCategory=function(b){return b.SiteID=d.site.SiteID,a.post(c.apiServiceBaseUri+f+"/category",b)},g.getTags=function(b){return a.get(c.apiServiceBaseUri+f+"/tag?Query="+b)},g}]),app.factory("brandService",["$myhttp","$q","ngAuthSettings","siteService",function(a,b,c,d){var e="api/brand",f={};return f.get=function(){return a.get(c.apiServiceBaseUri+e+"?SiteID="+d.site.SiteID)},f.save=function(b){return b.SiteID=d.site.SiteID,a.post(c.apiServiceBaseUri+e,b)},f.remove=function(b){return a["delete"](c.apiServiceBaseUri+e+"?BrandID="+b)},f}]),app.factory("categoryService",["$myhttp","$q","ngAuthSettings","siteService",function(a,b,c,d){var e="api/category",f={};return f.get=function(){return a.get(c.apiServiceBaseUri+e+"?SiteID="+d.site.SiteID)},f.save=function(b){return b.SiteID=d.site.SiteID,a.post(c.apiServiceBaseUri+e,b)},f.up=function(b,d){return a.post(c.apiServiceBaseUri+e+"/up-or-down",{CategoryID:b,Up:d})},f.remove=function(b){return a["delete"](c.apiServiceBaseUri+e+"?CategoryID="+b)},f}]),app.factory("contentService",["$myhttp","$q","ngAuthSettings","siteService","cultureService",function(a,b,c,d,e){return{get:function(){return a.get(c.apiServiceBaseUri+"api/content?SiteID="+d.site.SiteID)},getMenu:function(){return a.get(c.apiServiceBaseUri+"api/content/menu?SiteID="+d.site.SiteID+"&CultureID="+e.currentCulture.CultureID)},getTree:function(){return a.get(c.apiServiceBaseUri+"api/content?SiteID="+d.site.SiteID+"&CultureID="+e.currentCulture.CultureID)},getTreeByProperty:function(b){return a.get(c.apiServiceBaseUri+"api/content/property?ContentPropertyID="+b+"&CultureID="+e.currentCulture.CultureID)},save:function(b){return b.SiteID=d.site.SiteID,a.post(c.apiServiceBaseUri+"api/content",b)},saveTree:function(b){var f={SiteID:d.site.SiteID,CultureID:e.currentCulture.CultureID,Items:b};return a.post(c.apiServiceBaseUri+"api/content/save-tree",f)},remove:function(b){return a["delete"](c.apiServiceBaseUri+"api/content?ContentPropertyID="+b.ContentPropertyID)},move:function(b,d,e){return a.post(c.apiServiceBaseUri+"api/content/move",{Index:b,ContentPropertyParentID:d,ContentPropertyID:e})},duplicate:function(b){return b.SiteID=d.site.SiteID,a.post(c.apiServiceBaseUri+"api/content/duplicate",b)},duplicateTree:function(b){return b.SiteID=d.site.SiteID,b.CultureID=e.currentCulture.CultureID,a.post(c.apiServiceBaseUri+"api/content/duplicate-tree",b)},exportContent:function(b){return a.get(c.apiServiceBaseUri+"api/content/export?SiteID="+d.site.SiteID+"&ContentPropertyID="+b)},importContent:function(b,e){var f={SiteID:d.site.SiteID,ContentPropertyID:b,FileRead:e};return a.post(c.apiServiceBaseUri+"api/content/import",f)},lock:function(b,d){return a.post(c.apiServiceBaseUri+"api/content/lock",{ContentPropertyID:b,Boolean:d})},enable:function(b,d){return a.post(c.apiServiceBaseUri+"api/content/enable",{ContentPropertyID:b,Boolean:d})},lockAll:function(){return a.post(c.apiServiceBaseUri+"api/content/lock-all",d.site.SiteID)},showInContent:function(b,d){return a.post(c.apiServiceBaseUri+"api/content/show-in-content",{ContentPropertyID:b,Boolean:d})},inMenu:function(b,d){return a.post(c.apiServiceBaseUri+"api/content/inmenu",{ContentPropertyID:b,Boolean:d})}}}]),app.factory("cultureService",["$myhttp","$q","ngAuthSettings","siteService",function(a,b,c,d){var e={};return e.cultures=[],e.currentCulture={},e.get=function(){var f=b.defer();return a.get(c.apiServiceBaseUri+"api/culture?SiteID="+d.site.SiteID).then(function(a){e.cultures=a,e.currentCulture=a[0],f.resolve(a)})},e.save=function(b){return a.post(c.apiServiceBaseUri+"api/culture",b)},e}]),app.factory("currencyService",["$myhttp","$q","ngAuthSettings","siteService",function(a,b,c,d){var e="api/currency",f={};return f.get=function(){return a.get(c.apiServiceBaseUri+e+"?SiteID="+d.site.SiteID)},f.save=function(b){return b.SiteID=d.site.SiteID,a.post(c.apiServiceBaseUri+e,b)},f["default"]=function(b){return a.put(c.apiServiceBaseUri+e+"/default?CurrencyID="+b)},f.remove=function(b){return a["delete"](c.apiServiceBaseUri+e+"?CurrencyID="+b)},f}]),app.factory("mediaService",["$myhttp","$q","ngAuthSettings","siteService",function(a,b,c,d){var e="api/media",f={};return f.get=function(){return a.get(c.apiServiceBaseUri+e+"?SiteID="+d.site.SiteID)},f.upload=function(b){return a.post(c.apiServiceBaseUri+e,b)},f.remove=function(b){return a["delete"](c.apiServiceBaseUri+e+"?MediaID="+b.MediaID+"&SiteID="+d.site.SiteID)},f}]),app.factory("$myhttp",["$http","$q","utilService","authService","localStorageService",function(a,b,c,d,e){var f={};return f.get=function(g,h){var i=b.defer();return a.get(g).success(function(a){i.resolve(a)}).error(function(a,b){if(401===b){var h=e.get("authorizationData");h?h.useRefreshTokens&&d.refreshToken().then(function(){f.get(g).then(function(a){i.resolve(a)})}):d.logOut()}else c.errorCallback(a),i.reject(a)}),i.promise},f.post=function(g,h){var i=b.defer();return a.post(g,h).success(function(a){i.resolve(a)}).error(function(a,b){if(401===b){var j=e.get("authorizationData");j?j.useRefreshTokens&&d.refreshToken().then(function(){f.post(g,h).then(function(a){i.resolve(a)})}):d.logOut()}else c.errorCallback(a),i.reject(a)}),i.promise},f.put=function(g,h){var i=b.defer();return a.put(g,h).success(function(a){i.resolve(a)}).error(function(a,b){if(401===b){var j=e.get("authorizationData");j?j.useRefreshTokens&&d.refreshToken().then(function(){f.put(g,h).then(function(a){i.resolve(a)})}):d.logOut()}else c.errorCallback(a),i.reject(a)}),i.promise},f["delete"]=function(g){var h=b.defer();return a["delete"](g).success(function(a){h.resolve(a)}).error(function(a,b){if(401===b){var i=e.get("authorizationData");i?i.useRefreshTokens&&d.refreshToken().then(function(){f["delete"](g).then(function(a){h.resolve(a)})}):d.logOut()}else c.errorCallback(a),h.reject(a)}),h.promise},f}]),app.factory("orderService",["$myhttp","$q","ngAuthSettings","siteService",function(a,b,c,d){var e="api/order",f={};return f.get=function(){return a.get(c.apiServiceBaseUri+e+"?SiteID="+d.site.SiteID)},f.save=function(b){return b.SiteID=d.site.SiteID,a.post(c.apiServiceBaseUri+e,b)},f.remove=function(b){return a["delete"](c.apiServiceBaseUri+e+"?OrderID="+b)},f}]),app.factory("pageService",["$myhttp","ngAuthSettings","siteService",function(a,b,c){return{get:function(){return a.get(b.apiServiceBaseUri+"api/page?SiteID="+c.site.SiteID)},getDetail:function(c,d){return a.get(b.apiServiceBaseUri+"api/page?PageID="+c+"&CultureID="+d)},save:function(d){return d.SiteID=c.site.SiteID,a.post(b.apiServiceBaseUri+"api/page",d)},saveCulture:function(d){return d.SiteID=c.site.SiteID,a.post(b.apiServiceBaseUri+"api/page/save-culture",d)},remove:function(c){return a["delete"](b.apiServiceBaseUri+"api/page?PageID="+c.PageID)},move:function(c,d,e){return a.post(b.apiServiceBaseUri+"api/page/move",{Index:c,PageParentID:d,PageID:e})},inMenu:function(c,d){return a.post(b.apiServiceBaseUri+"api/page/in-menu",{PageID:c,Published:d})}}}]),app.factory("productService",["$myhttp","$q","Upload","ngAuthSettings","siteService",function(a,b,c,d,e){var f="api/product",g="api/product-gallery",h={};return h.get=function(b){return a.get(d.apiServiceBaseUri+f+"?SiteID="+e.site.SiteID+"&CategoryID="+b)},h.getByID=function(b){return a.get(d.apiServiceBaseUri+f+"/byID?ProductID="+b)},h.save=function(b){return b.SiteID=e.site.SiteID,a.post(d.apiServiceBaseUri+f,b)},h.remove=function(b){return a["delete"](d.apiServiceBaseUri+f+"?ProductID="+b)},h.ProductBooleanType={Enable:0,New:1,Featured:2},h.enable=function(b,c,e){return a.post(d.apiServiceBaseUri+f+"/enable",{ProductID:b,Boolean:c,ProductBooleanType:e})},h.removeGallery=function(b){return a["delete"](d.apiServiceBaseUri+f+"/gallery?GalleryID="+b)},h.move=function(b,c,e){return a.post(d.apiServiceBaseUri+f+"/move",{ProductID:b,CategoryID:c,Index:e})},h.uploadGallery=function(a,b){return c.upload({url:d.apiServiceBaseUri+g+"/upload",fields:{ProductID:a},file:b})},h.getCategories=function(b){return a.get(d.apiServiceBaseUri+f+"/categories?SiteID="+e.site.SiteID+"&Query="+b)},h.getCategories=function(){return a.get(d.apiServiceBaseUri+f+"/categories?SiteID="+e.site.SiteID)},h.getCategoriesUrl=function(){return d.apiServiceBaseUri+f+"/categories?SiteID="+e.site.SiteID+"&Query=%QUERY"},h.getTags=function(b){return a.get(d.apiServiceBaseUri+f+"/tags?SiteID="+e.site.SiteID+"&Query="+b)},h}]),app.factory("siteService",["$myhttp","$q","ngAuthSettings","localStorageService",function(a,b,c,d){var e={};return e.site={},e.sites=[],e.sitesLoaded=!1,e.getSites=function(){var f=b.defer();return a.get(c.apiServiceBaseUri+"api/site").then(function(a){var b=d.get("site"),c=!1;null!=b&&angular.forEach(a,function(a){a.SiteID==b.SiteID&&(c=!0)}),c?e.site=b:(e.site=a[0],b=e.site),e.sites=a,e.sitesLoaded=!0,d.set("site",e.site),f.resolve(a)}),f.promise},e.save=function(d){var f=b.defer();return a.put(c.apiServiceBaseUri+"api/site",d).then(function(a){e.site=d,f.resolve(a)}),f.promise},e.change=function(a){e.site=a,d.set("site",a)},e}]),app.factory("tagService",["$myhttp","$q","ngAuthSettings","siteService",function(a,b,c,d){var e="api/tag",f={};return f.get=function(){return a.get(c.apiServiceBaseUri+e+"?SiteID="+d.site.SiteID)},f.save=function(b){return b.SiteID=d.site.SiteID,a.post(c.apiServiceBaseUri+e,b)},f.remove=function(b){return a["delete"](c.apiServiceBaseUri+e+"?tagID="+b)},f}]),app.factory("toastrService",[function(){return{success:function(a){toastr.success(a)},error:function(a){if(null!=a.ModelState)for(var b in a.ModelState)for(var c=0;c<a.ModelState[b].length;c++)toastr.error(a.ModelState[b][c],"Error");else null!=a.Message?toastr.error(a.Message,"Error"):toastr.error(a,"Error")}}}]),app.factory("utilService",["toastrService",function(a){return{errorCallback:function(b){a.error(b)}}}]),app.controller("loginController",["$scope","$location","authService","ngAuthSettings",function(a,b,c,d){c.authentication.isAuth&&(window.location="/app"),a.loginData={userName:"",password:"",useRefreshTokens:!1},a.message="",a.login=function(){a.$broadcast("autofill:update"),c.login(a.loginData).then(function(a){window.location="/app"},function(b){a.message=b.error_description})},a.authExternalProvider=function(b){var c=location.protocol+"//"+location.host+"/authcomplete.html",e=d.apiServiceBaseUri+"api/Account/ExternalLogin?provider="+b+"&response_type=token&client_id="+d.clientId+"&redirect_uri="+c;window.$windowScope=a;window.open(e,"Authenticate Account","location=0,status=0,width=600,height=750")},a.authCompletedCB=function(d){a.$apply(function(){if("False"==d.haslocalaccount)c.logOut(),c.externalAuthData={provider:d.provider,userName:d.external_user_name,externalAccessToken:d.external_access_token},b.path("/associate");else{var e={provider:d.provider,externalAccessToken:d.external_access_token};c.obtainAccessToken(e).then(function(a){b.path("/orders")},function(b){a.message=b.error_description})}})}}]),app.directive("autoFillSync",["$timeout",function(a){return{restrict:"A",require:"ngModel",link:function(a,b,c,d){a.$on("autofill:update",function(){d.$setViewValue(b.val())})}}}]);